{% extends 'base.html' %}
{% block title %}Analytics | T4G Dashboard{% endblock %}

{% block content %}
<h1 class="mb-4">ðŸ“Š Analytics Dashboard</h1>
<p class="lead">
  Welcome to the analytics dashboard. Here you can view business statistics and trends for your solar boards.
</p>

<!-- Business Analytics Summary -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow border-0">
      <div class="card-body">
        <h5 class="card-title mb-3">
          <i class="bi bi-graph-up-arrow"></i> Business Analytics Summary
        </h5>
        <div id="analyticsSummary">
          <div class="text-secondary">Loading analytics...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row my-4">
  <!-- Inspection Accuracy -->
  <div class="col-md-4 mb-4">
    <a href="{{ url_for('inspection_accuracy') }}" class="text-decoration-none text-dark">
      <div class="card h-100 shadow border-0">
        <div class="card-body">
          <h5 class="card-title">
            <i class="bi bi-bullseye"></i> Inspection Accuracy
          </h5>

          <!-- â—€ NEW: Numeric accuracy display -->
          <div class="text-center mb-3">
            <h3 id="accuracyValue" class="fw-bold">--%</h3>
          </div>

          <canvas id="accuracyGauge"></canvas>
        </div>
      </div>
    </a>
  </div>


  <!-- Cracked Boards Rate (clickable) -->
  <div class="col-md-4 mb-4">
    <a href="{{ url_for('cracked_board_rate') }}" class="text-decoration-none text-dark">
      <div class="card h-100 shadow border-0">
        <div class="card-body">
          <h5 class="card-title">
            <i class="bi bi-exclamation-triangle"></i>
            Cracked Boards Rate
          </h5>

          <!-- Only Total Boards card -->
          <div class="mb-4">
            <div class="row text-center">
              <div class="col-12 mb-2">
                <div class="card border-primary shadow-sm">
                  <div class="card-body">
                    <h5>Total Boards</h5>
                    <h3 id="totalBoards" class="text-primary fw-bold">--</h3>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- History Pie Chart -->
          <canvas id="statusChart"></canvas>
        </div>
      </div>
    </a>
  </div>

  <!-- Thermal Trends -->
  <div class="col-md-4 mb-4">
    <a href="{{ url_for('thermal_trends') }}" class="text-decoration-none text-dark">
      <div class="card h-100 shadow border-0">
        <div class="card-body">
          <h5 class="card-title">
            <i class="bi bi-thermometer-half"></i> Thermal Trends
          </h5>

          <!-- Average Temperature by Area -->
          <canvas id="thermalAvgChart" class="mb-4"></canvas>

          <!-- Temperature Distribution Histogram -->
          <canvas id="thermalHistChart"></canvas>
        </div>
      </div>
  </div>
  </a>
</div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // 1) Fetch and render the top Business Analytics Summary
  fetch('/api/analytics_data')
    .then(r => r.json())
    .then(data => {
      // handle errors / no data
      if (data.error) {
        document.getElementById('analyticsSummary').innerHTML =
          `<div class="text-danger">Error loading analytics: ${data.error}</div>`;
        return;
      }
      if (!data.total_boards) {
        document.getElementById('analyticsSummary').innerHTML =
          `<div class="text-warning">No analytics data available.</div>`;
        return;
      }

      // build summary badges
      const summaryHtml = `
      <div class="row text-center">
        <div class="col-md-2 mb-2">
          <span class="badge bg-primary fs-5">
            <i class="bi bi-collection"></i> ${data.total_boards}
          </span><br><small>Total Boards</small>
        </div>
        <div class="col-md-2 mb-2">
          <span class="badge bg-danger fs-5">
            <i class="bi bi-exclamation-octagon"></i> ${data.cracked_boards}
          </span><br><small>Cracked</small>
        </div>
        <div class="col-md-2 mb-2">
          <span class="badge bg-success fs-5">
            <i class="bi bi-check-circle"></i> ${data.healthy_boards}
          </span><br><small>Healthy</small>
        </div>
        <div class="col-md-2 mb-2">
          <span class="badge bg-secondary fs-5">
            <i class="bi bi-question-circle"></i> ${data.unknown_boards}
          </span><br><small>Unknown</small>
        </div>
      <!-- PDF Download inline, beside Unknown -->
    <div class="col-md-2 mb-2">
      <form action="{{ url_for('generate_report_route') }}" method="post"
            class="d-flex flex-column align-items-center">
        <select name="period" class="form-select form-select-sm mb-1" required>
          <option value="" disabled selected>Periodâ€¦</option>
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
        </select>
        <button type="submit" class="btn btn-b btn-primary">Generate Report</button>
      </form>
    </div>

      </div>
      <div class="row mt-3">
        <div class="col-12">
          <div class="card bg-light border-0">
            <div class="card-body p-2">
              <strong>Status Breakdown:</strong>
              <ul class="list-inline mb-0">
                ${Object.entries(data.status_counts).map(
        ([s, c]) => `<li class="list-inline-item">
                    <span class="badge bg-dark">${s}: ${c}</span>
                  </li>`
      ).join('')}
              </ul>
            </div>
          </div>
        </div>
      </div>`;
      document.getElementById('analyticsSummary').innerHTML = summaryHtml;

      // 2) Populate only the Total Boards card in Cracked Boards Rate
      document.getElementById('totalBoards').textContent = data.total_boards;

      // 3) Draw the history pie chart
      const hc = data.history_counts || {};
      new Chart(
        document.getElementById('statusChart').getContext('2d'),
        {
          type: 'pie',
          data: {
            labels: Object.keys(hc).map(
              s => s.charAt(0).toUpperCase() + s.slice(1)
            ),
            datasets: [{ data: Object.values(hc) }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              title: {
                display: true,
                text: 'Status History Distribution'
              }
            }
          }
        }
      );
    })
    .catch(err => {
      document.getElementById('analyticsSummary').innerHTML =
        `<div class="text-danger">Failed to load analytics: ${err}</div>`;
    });


  // 4) Dynamic Inspection Accuracy gauge
  fetch('/api/best_metrics')
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        console.error(data.error);
        return;
      }
      const pct = Math.round(data.accuracy * 100);
      const remainder = 100 - pct;

      // â—€ NEW: show percentage in the card
      document.getElementById('accuracyValue').textContent = pct + '%';

      let color;
      if (pct > 90) color = 'blue';
      else if (pct >= 80) color = 'green';
      else if (pct >= 50) color = 'yellow';
      else color = 'red';

      new Chart(
        document.getElementById('accuracyGauge'),
        {
          type: 'doughnut',
          data: {
            labels: ['Accuracy', 'Remaining'],
            datasets: [{
              data: [pct, remainder],
              backgroundColor: [color, '#dee2e6']
            }]
          },
          options: {
            cutout: '80%',
            plugins: {
              tooltip: {
                callbacks: { label: ctx => `${ctx.label}: ${ctx.parsed}%` }
              }
            }
          }
        }
      );
    })
    .catch(err => console.error('Failed to load best metrics', err));




  // 5) Draw Thermal Trends charts
  fetch('/api/products_data')
    .then(r => r.json())
    .then(products => {
      // aggregate all thermal readings by area
      const areaTemps = {};
      products.forEach(p => {
        const tb = p.thermal_by_timestamp || {};
        Object.values(tb).forEach(areaObj => {
          Object.entries(areaObj).forEach(([area, grid]) => {
            const flat = grid.flat();
            areaTemps[area] = (areaTemps[area] || []).concat(flat);
          });
        });
      });

      // â€”â€”â€” 1) Average temp per area â€”â€”â€”
      const areas = Object.keys(areaTemps).sort();
      const avgTemps = areas.map(a => {
        const arr = areaTemps[a];
        return arr.reduce((s, v) => s + v, 0) / arr.length;
      });

      new Chart(
        document.getElementById('thermalAvgChart').getContext('2d'),
        {
          type: 'line',                   // â† line instead of bar
          data: {
            labels: areas,
            datasets: [{
              label: 'Avg Temp (Â°C)',
              data: avgTemps,
              fill: false,
              tension: 0.3                  // smooth curve (optional)
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: 'Average Temperature by Area'
              }
            },
            scales: {
              y: {
                title: { display: true, text: 'Temperature (Â°C)' }
              },
              x: {
                title: { display: true, text: 'Area' }
              }
            }
          }
        }
      );


      // â€”â€”â€” 2) Temperature distribution histogram â€”â€”â€”
      let below = 0, normal = 0, above = 0;
      Object.values(areaTemps).flat().forEach(v => {
        if (v < 25) below++;
        else if (v > 38) above++;
        else normal++;
      });

      new Chart(
        document.getElementById('thermalHistChart').getContext('2d'),
        {
          type: 'bar',
          data: {
            labels: ['BelowÂ 25Â°C', '25â€“38Â°C', 'AboveÂ 38Â°C'],
            datasets: [{
              label: 'Count',
              data: [below, normal, above]
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: 'Temperature Distribution'
              }
            }
          }
        }
      );
    })
    .catch(err => console.error('Thermal data load failed', err));

</script>
{% endblock %}