{% extends 'base.html' %}
{% block title %}Analytics | T4G Dashboard{% endblock %}

{% block content %}
<h1 class="mb-4">ðŸ“Š Analytics Dashboard</h1>
<p class="lead">
  Welcome to the analytics dashboard. Here you can view business statistics and trends for your solar boards.
</p>

<!-- Business Analytics Summary -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow border-0">
      <div class="card-body">
        <h5 class="card-title mb-3">
          <i class="bi bi-graph-up-arrow"></i> Business Analytics Summary
        </h5>
        <div id="analyticsSummary">
          <div class="text-secondary">Loading analytics...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row my-4">
   <!-- Inspection Accuracy -->
   <div class="col-md-4 mb-4">
    <a href="{{ url_for('inspection_accuracy') }}" class="text-decoration-none text-dark">
      <div class="card h-100 shadow border-0">
      <div class="card-body">
        <h5 class="card-title">
          <i class="bi bi-bullseye"></i> Inspection Accuracy
        </h5>

        <!-- â—€ NEW: Numeric accuracy display -->
        <div class="text-center mb-3">
          <h3 id="accuracyValue" class="fw-bold">--%</h3>
        </div>

        <canvas id="accuracyGauge"></canvas>
      </div>
    </div>
  </a> 
  </div>


  <!-- Cracked Boards Rate (clickable) -->
  <div class="col-md-4 mb-4">
    <a href="{{ url_for('cracked_board_rate') }}" class="text-decoration-none text-dark">
      <div class="card h-100 shadow border-0">
        <div class="card-body">
          <h5 class="card-title">
            <i class="bi bi-exclamation-triangle"></i>
            Cracked Boards Rate
          </h5>

          <!-- Only Total Boards card -->
          <div class="mb-4">
            <div class="row text-center">
              <div class="col-12 mb-2">
                <div class="card border-primary shadow-sm">
                  <div class="card-body">
                    <h5>Total Boards</h5>
                    <h3 id="totalBoards" class="text-primary fw-bold">--</h3>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- History Pie Chart -->
          <canvas id="statusChart"></canvas>
        </div>
      </div>
    </a>
  </div>

  <!-- Temperature Trends -->
  <div class="col-md-4 mb-4">
    <div class="card h-100 shadow border-0">
      <div class="card-body">
        <h5 class="card-title">
          <i class="bi bi-thermometer-half"></i> Temperature Trends
        </h5>
        <canvas id="tempChart"></canvas>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // 1) Fetch and render the top Business Analytics Summary
  fetch('/api/analytics_data')
    .then(r => r.json())
    .then(data => {
      // handle errors / no data
      if (data.error) {
        document.getElementById('analyticsSummary').innerHTML =
          `<div class="text-danger">Error loading analytics: ${data.error}</div>`;
        return;
      }
      if (!data.total_boards) {
        document.getElementById('analyticsSummary').innerHTML =
          `<div class="text-warning">No analytics data available.</div>`;
        return;
      }

      // build summary badges
      const summaryHtml = `
      <div class="row text-center">
        <div class="col-md-2 mb-2">
          <span class="badge bg-primary fs-5">
            <i class="bi bi-collection"></i> ${data.total_boards}
          </span><br><small>Total Boards</small>
        </div>
        <div class="col-md-2 mb-2">
          <span class="badge bg-danger fs-5">
            <i class="bi bi-exclamation-octagon"></i> ${data.cracked_boards}
          </span><br><small>Cracked</small>
        </div>
        <div class="col-md-2 mb-2">
          <span class="badge bg-success fs-5">
            <i class="bi bi-check-circle"></i> ${data.healthy_boards}
          </span><br><small>Healthy</small>
        </div>
        <div class="col-md-2 mb-2">
          <span class="badge bg-secondary fs-5">
            <i class="bi bi-question-circle"></i> ${data.unknown_boards}
          </span><br><small>Unknown</small>
        </div>
        <div class="col-md-2 mb-2">
          <span class="badge bg-info text-dark fs-5">
            <i class="bi bi-images"></i> ${data.avg_images_per_board}
          </span><br><small>Avg Images/Board</small>
        </div>
        <div class="col-md-2 mb-2">
          <span class="badge bg-warning text-dark fs-5">
            <i class="bi bi-image"></i> ${data.total_images}
          </span><br><small>Total Images</small>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-12">
          <div class="card bg-light border-0">
            <div class="card-body p-2">
              <strong>Status Breakdown:</strong>
              <ul class="list-inline mb-0">
                ${Object.entries(data.status_counts).map(
        ([s, c]) => `<li class="list-inline-item">
                    <span class="badge bg-dark">${s}: ${c}</span>
                  </li>`
      ).join('')}
              </ul>
            </div>
          </div>
        </div>
      </div>`;
      document.getElementById('analyticsSummary').innerHTML = summaryHtml;

      // 2) Populate only the Total Boards card in Cracked Boards Rate
      document.getElementById('totalBoards').textContent = data.total_boards;

      // 3) Draw the history pie chart
      const hc = data.history_counts || {};
      new Chart(
        document.getElementById('statusChart').getContext('2d'),
        {
          type: 'pie',
          data: {
            labels: Object.keys(hc).map(
              s => s.charAt(0).toUpperCase() + s.slice(1)
            ),
            datasets: [{ data: Object.values(hc) }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              title: {
                display: true,
                text: 'Status History Distribution'
              }
            }
          }
        }
      );
    })
    .catch(err => {
      document.getElementById('analyticsSummary').innerHTML =
        `<div class="text-danger">Failed to load analytics: ${err}</div>`;
    });


  // 4) Dynamic Inspection Accuracy gauge
fetch('/api/best_metrics')
  .then(r => r.json())
  .then(data => {
    if (data.error) {
      console.error(data.error);
      return;
    }
    const pct = Math.round(data.accuracy * 100);
    const remainder = 100 - pct;

    // â—€ NEW: show percentage in the card
    document.getElementById('accuracyValue').textContent = pct + '%';

    let color;
    if      (pct >  90) color = 'blue';
    else if (pct >= 80) color = 'green';
    else if (pct >= 50) color = 'yellow';
    else                color = 'red';

    new Chart(
      document.getElementById('accuracyGauge'),
      {
        type: 'doughnut',
        data: {
          labels: ['Accuracy','Remaining'],
          datasets: [{
            data: [pct, remainder],
            backgroundColor: [color, '#dee2e6']
          }]
        },
        options: {
          cutout: '80%',
          plugins: {
            tooltip: {
              callbacks: { label: ctx => `${ctx.label}: ${ctx.parsed}%` }
            }
          }
        }
      }
    );
  })
  .catch(err => console.error('Failed to load best metrics', err));




  // 5) Draw the Temperature Trends line chart (unchanged)
  new Chart(document.getElementById('tempChart'), {
    type: 'line',
    data: {
      labels: ['10:00', '10:05', '10:10', '10:15'],
      datasets: [{
        label: 'Avg Temperature (Â°C)',
        data: [35, 36, 34, 37],
        fill: false,
        borderColor: 'blue'
      }]
    }
  });
</script>
{% endblock %}