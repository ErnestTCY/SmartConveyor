{% extends 'base.html' %}
{% block title %}Product Detail | T4G Dashboard{% endblock %}
{% block content %}

<style>
    .timestamp-hover-wrapper {
        position: relative;
        display: block;
    }
    
    .timestamp-hover-popup {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1000;
        background-color: #f8f9fa;
        border: 1px solid #ccc;
        padding: 5px 10px;
        font-size: 0.85rem;
        color: #333;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        white-space: nowrap;
    }
    
    .timestamp-hover-wrapper:hover .timestamp-hover-popup {
        display: block;
    }
    </style>
    

<div class="container py-4">
    <h2 class="mb-4">üîç Product Details</h2>

    {% if product %}
    <div class="row">
        <!-- Image Section -->
        <div class="col-md-5 mb-4">
            <h5>üì∏ Latest Images</h5>
            {% if product.images %}
            <div id="imageCarousel" class="carousel slide mb-3" data-bs-ride="carousel">
                <div class="carousel-inner">
                    {% for image in product.images %}
                    <div class="carousel-item {% if loop.first %}active{% endif %}">
                        <img src="{{ url_for('static', filename=image) }}" alt="Product Image"
                            class="d-block w-100 rounded border" style="max-height: 300px; object-fit: contain;">
                    </div>
                    {% endfor %}
                </div>
                {% if product.images|length > 1 %}
                <button class="carousel-control-prev" type="button" data-bs-target="#imageCarousel"
                    data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#imageCarousel"
                    data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
                {% endif %}
            </div>
            <div class="text-center">
                <small class="text-muted">{{ product.images|length }} image(s) from latest timestamp</small>
            </div>
            {% else %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> No images found for this product.
            </div>
            {% endif %}

            <!-- ‚úÖ Image History Section with working hover popup -->
            {% if product.image_history %}
            <div class="mt-4">
                <h6>üìö Image History</h6>
                <div class="accordion" id="imageHistoryAccordion">
                    {% for timestamp, images in product.image_history.items() %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading{{ loop.index }}">
                            <div class="timestamp-hover-wrapper">
                                <button class="accordion-button collapsed w-100 text-start" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}"
                                    aria-expanded="false" aria-controls="collapse{{ loop.index }}">
                                    {{ timestamp }} ({{ images|length }} image(s))
                                </button>
                                <div class="timestamp-hover-popup">
                                    Timestamp: {{ timestamp }}<br>
                                    {{ images|length }} image(s)
                                </div>
                            </div>
                        </h2>
                        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse"
                            aria-labelledby="heading{{ loop.index }}" data-bs-parent="#imageHistoryAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    {% for image in images %}
                                    <div class="col-md-6 mb-2">
                                        <img src="{{ url_for('static', filename=image) }}" alt="Historical Image"
                                            class="img-fluid rounded border"
                                            style="max-height: 150px; object-fit: contain;">
                                        <div class="text-center mt-1">
                                            <small class="text-muted">{{ image.split('/')[-1] }}</small>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- ‚úÖ Thermal History Section with working hover popup -->
            {% if product.thermal_history %}
            <div class="mt-4">
                <h6>üå°Ô∏è Thermal History</h6>
                <div class="accordion" id="thermalHistoryAccordion">
                    {% for timestamp, images in product.thermal_history.items() %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="thermalHeading{{ loop.index }}">
                            <div class="timestamp-hover-wrapper">
                                <button class="accordion-button collapsed w-100 text-start" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#thermalCollapse{{ loop.index }}"
                                    aria-expanded="false" aria-controls="thermalCollapse{{ loop.index }}">
                                    {{ timestamp }} ({{ images|length }} thermal image(s))
                                </button>
                                <div class="timestamp-hover-popup">
                                    Timestamp: {{ timestamp }}<br>
                                    {{ images|length }} thermal image(s)
                                </div>
                            </div>
                        </h2>
                        <div id="thermalCollapse{{ loop.index }}" class="accordion-collapse collapse"
                            aria-labelledby="thermalHeading{{ loop.index }}" data-bs-parent="#thermalHistoryAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    {% for image in images %}
                                    <div class="col-md-6 mb-2">
                                        <img src="{{ url_for('static', filename=image) }}" alt="Thermal Image"
                                            class="img-fluid rounded border"
                                            style="max-height: 150px; object-fit: contain;">
                                        <div class="text-center mt-1">
                                            <small class="text-muted">{{ image.split('/')[-1] }}</small>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

        </div>
        <!-- Form Section -->
        <div class="col-md-7">
            <form method="post" id="productForm">
                <div class="mb-3">
                    <label for="serial_number" class="form-label">Serial Number</label>
                    <input type="text" class="form-control" id="serial_number" name="serial_number"
                        value="{{ product.serial_number }}" readonly>
                </div>

                <div class="mb-3">
                    <label for="model_name" class="form-label">Model Name</label>
                    <input type="text" class="form-control" id="model_name" name="model_name"
                        value="{{ product.model_name }}" disabled>
                </div>

                <div class="mb-3">
                    <label class="form-label">Status</label>
                    <div class="mb-3 d-flex align-items-center">

                        {# Render your crack/scratch/normal badges #}
                        {% set statuses = product.status if (product.status is iterable and not product.status is
                        string) else [product.status] %}
                        {% for st in statuses %}
                        <span class="badge 
                                {% if st=='cracked' or st=='crack'   %}bg-danger
                                {% else                             %}bg-success
                                {% endif %} me-1">
                            {{ st }}
                        </span>
                        {% endfor %}

                        {# Inline button, styled like a form button #}
                        <button id="refreshStatusBtn" class="btn btn-outline-secondary btn-sm ms-3" type="button"
                            title="Update status">
                            üîÑ
                        </button>
                    </div>

                </div>

                <div class="d-flex gap-3">
                    <button type="button" class="btn btn-warning" onclick="enableEditing()">‚úèÔ∏è Edit</button>
                    <button type="submit" class="btn btn-success d-none" id="saveBtn">üíæ Save</button>
                    <a href="{{ url_for('database') }}" class="btn btn-secondary">‚Üê Back</a>
                </div>
            </form>

            <!-- LLM Reasoning Section -->
            <div class="mt-4">
                <h6>ü§ñ LLM Reasoning</h6>
                <div class="mb-2">
                    <label for="timestampSelect" class="form-label">Select Timestamp</label>
                    <select id="timestampSelect" class="form-select">
                        {% for ts in product.image_history.keys() %}
                        <option value="{{ ts }}">{{ ts }}</option>
                        {% endfor %}
                    </select>
                    <span id="statusDisplay"
                        class="badge ms-2 {% if product.status_by_timestamp[product.image_history.keys()|list|first] == 'crack' %}bg-danger{% elif product.status_by_timestamp[product.image_history.keys()|list|first] == 'normal' %}bg-success{% else %}bg-warning{% endif %}">
                        {{ product.status_by_timestamp[product.image_history.keys()|list|first] }}
                    </span>
                </div>
                <div id="reasoningBox" class="border rounded p-3 bg-light" style="min-height: 100px;">
                    <div id="reasoningText" style="white-space: pre-wrap;">Select a timestamp to view reasoning.</div>
                </div>
                <button id="generateReasoningBtn" class="btn btn-info btn-sm mt-2" style="display:none;">Generate
                    Reasoning</button>
                <div id="reasoningSpinner" class="mt-2" style="display:none;">
                    <div class="spinner-border text-info" role="status"></div>
                    <span class="ms-2">Generating reasoning...</span>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-danger">‚ùå Product not found.</div>
    {% endif %}
</div>

<!-- JavaScript to enable editing and LLM reasoning -->
<script>
    const imageHistory = {{ product.image_history | tojson | safe }};
    const thermalHistory = {{ product.thermal_history | tojson | safe }};
    function enableEditing() {
        const form = document.getElementById('productForm');
        form.querySelectorAll('input:not([readonly])').forEach(field => {
            field.removeAttribute('disabled');
        });
        document.getElementById('saveBtn').classList.remove('d-none');
    }
    (function () {
        const btn = document.getElementById('refreshStatusBtn');
        if (!btn) return;

        btn.addEventListener('click', () => {
            // Grab the serial and timestamp from template variables
            const serial = "{{ product.serial_number }}";
            const ts = "{{ request.args.get('ts') or product.image_history.keys()|list|first }}";

            btn.disabled = true;
            btn.textContent = '‚è≥';

            fetch(`/product/${serial}/refresh_status/${ts}`, {
                method: 'POST'
            })
                .then(res => {
                    if (!res.ok) throw new Error('Network response was not OK');
                    // reload to show updated badges
                    window.location.reload();
                })
                .catch(err => {
                    console.error(err);
                    btn.disabled = false;
                    btn.textContent = 'üîÑ';
                    alert('Failed to refresh status.');
                });
        });
    })();

    function updateStatusDisplay(ts) {
        const statusDisplay = document.getElementById('statusDisplay');
        statusDisplay.textContent = 'Loading...';
        fetch(`/get_status/{{ product.serial_number }}/${ts}`)
            .then(response => response.json())
            .then(data => {
                const status = data.status || 'unknown';
                statusDisplay.textContent = status;
                statusDisplay.className = 'badge ms-2 ' + (status === 'cracked' ? 'bg-danger' : (status === 'normal' ? 'bg-success' : 'bg-warning'));
            })
            .catch(err => {
                statusDisplay.textContent = 'unknown';
                statusDisplay.className = 'badge ms-2 bg-warning';
            });
    }

    function fetchReasoningForTimestamp(ts) {
        const reasoningBox = document.getElementById('reasoningBox');
        const reasoningText = document.getElementById('reasoningText');
        const spinner = document.getElementById('reasoningSpinner');
        const generateBtn = document.getElementById('generateReasoningBtn');
        spinner.style.display = 'block';
        reasoningText.textContent = 'Loading...';
        fetch(`/get_reasoning/{{ product.serial_number }}/${ts}`)
            .then(response => response.json())
            .then(data => {
                spinner.style.display = 'none';
                reasoningText.textContent = data.reasoning || data.message || 'No reasoning available.';
                generateBtn.style.display = 'inline-block';
            })
            .catch(err => {
                spinner.style.display = 'none';
                reasoningText.textContent = 'Failed to load reasoning.';
            });
    }

    document.getElementById('timestampSelect').addEventListener('change', function () {
        updateStatusDisplay(this.value);
    });
    // On page load, fetch for the first timestamp if available
    const tsSelect = document.getElementById('timestampSelect');
    if (tsSelect && tsSelect.value) {
        fetchReasoningForTimestamp(tsSelect.value);
        updateStatusDisplay(tsSelect.value);
    }
        // Generate reasoning button
        document.getElementById('generateReasoningBtn').addEventListener('click', function () {
        const ts = document.getElementById('timestampSelect').value;
        const spinner = document.getElementById('reasoningSpinner');
        const reasoningText = document.getElementById('reasoningText');
        spinner.style.display = 'block';
        reasoningText.textContent = 'Generating...';
        fetch(`/generate_reasoning/{{ product.serial_number }}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ timestamp: ts })
        })
        .then(response => response.json())
        .then(data => {
            spinner.style.display = 'none';
            reasoningText.textContent = data.reasoning || 'No reasoning available.';
            fetchReasoningForTimestamp(ts);
        })
        .catch(err => {
            spinner.style.display = 'none';
            reasoningText.textContent = 'Failed to generate reasoning.';
        });
    });

    document.querySelectorAll('.accordion-item').forEach(item => {
    const button = item.querySelector('.accordion-button');
    const collapseId = button.getAttribute('data-bs-target');
    const collapseEl = document.querySelector(collapseId);

    let hoverTimeout;

    function openAccordion() {
        if (button.classList.contains('collapsed')) {
            button.click();
        }
    }

    function closeAccordion() {
        if (!button.classList.contains('collapsed')) {
            button.click();
        }
    }

    function isMouseInsideAccordion(e) {
        return item.contains(e.relatedTarget);
    }

    item.addEventListener('mouseenter', () => {
        clearTimeout(hoverTimeout);
        openAccordion();
    });

    item.addEventListener('mouseleave', (e) => {
        hoverTimeout = setTimeout(() => {
            if (!isMouseInsideAccordion(e)) {
                closeAccordion();
            }
        }, 150); // optional delay before closing
    });
});


</script>

{% endblock %}