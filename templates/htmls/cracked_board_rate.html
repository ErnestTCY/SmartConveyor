{% extends 'base.html' %}
{% block title %}Cracked Board Rate | T4G Dashboard{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="text-center mb-4">ğŸ“Š Cracked Board Rate Analytics</h2>

  <!-- Status History Summary -->
  <h4 class="mt-5 text-center">Status History Summary</h4>
  <div class="row text-center mb-4" id="historySummary">
    <!-- injected by JS -->
  </div>

  <!-- Pie Chart -->
  <div class="row mb-5">
    <div class="col-md-8 offset-md-2">
      <canvas id="statusChart"></canvas>
    </div>
  </div>

  <div class="text-center">
    <a href="{{ url_for('analytics') }}" class="btn btn-outline-secondary">
      â† Back to Dashboard
    </a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
fetch('/api/analytics_data')
  .then(r => r.json())
  .then(data => {
    const hc       = data.history_counts || {};
    const totalHist = Object.values(hc).reduce((sum, v) => sum + v, 0) || 1;
    const row      = document.getElementById('historySummary');
    row.innerHTML  = '';

    // inject perâ€‘status summary cards
    Object.entries(hc).forEach(([status, cnt]) => {
      const pct = ((cnt / totalHist) * 100).toFixed(2);
      row.insertAdjacentHTML('beforeend', `
        <div class="col-md-3 mb-3">
          <div class="card border-info shadow-sm">
            <div class="card-body">
              <h5>${status.charAt(0).toUpperCase() + status.slice(1)}</h5>
              <h3>${cnt}</h3>
              <small>${pct}%</small>
            </div>
          </div>
        </div>
      `);
    });

    // draw history pie chart
    new Chart(
      document.getElementById('statusChart').getContext('2d'),
      {
        type: 'pie',
        data: {
          labels: Object.keys(hc).map(s => s.charAt(0).toUpperCase() + s.slice(1)),
          datasets: [{ data: Object.values(hc) }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            title: {
              display: true,
              text: 'Status History Distribution'
            }
          }
        }
      }
    );
  })
  .catch(err => console.error('âŒ History load failed', err));
</script>
{% endblock %}
